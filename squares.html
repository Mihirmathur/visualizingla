<!DOCTYPE html>
<html>
<style>
    body{
        background-color: #292444;
    }
    #grid{
        margin: 50px auto;
        width: 600px;
        height: 600px;
    }

    svg:hover{
        cursor: pointer;
    }

    svg.canvas, svg.building{
        overflow: visible;
    }
</style>
<body>
    <div class="container">
        <div id="grid"></div>
    </div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script>

    var canvas = d3.select('#grid');

    var canvasWidth = canvas.node().getBoundingClientRect().width;
    var canvasHeight = canvas.node().getBoundingClientRect().height;

    var width = 6, height = 6,
        off = 3;

    function initSingleBuilding(buildingHeight, buildingWidth) {
        var data = new Array();
        var xpos = 1, ypos = 1;
            
        var xOffset = 0,
            yOffset = 0;
        var xTrans = 0,
            yTrans = 0;

        for (var row = 0; row < buildingHeight/(height + off); row++) {
            data.push(new Array());
            for (var col = 0; col < buildingWidth/(width + off); col++) {
                data[row].push({
                    x: xpos,
                    y: ypos,
                    width: width - off,
                    height: height - off,
                    xOffset: xOffset,
                    yOffset: yOffset,
                    xTrans: xTrans,
                    yTrans: yTrans
                })
                xOffset += off;
                xpos += width;
            }
            xOffset = 0;
            yOffset += off;
            xpos = 1;
            ypos += height; 
        }
        return data;
    }

    function flyOut(d){
        var xOff = 30/(Math.random() - 0.5);
        var yOff = 30/(Math.random() - 0.5);
        d3.select(this)
            .attr('xTrans', function(d){return xOff;})
            .attr('yTrans', function(d){return yOff;})
            .transition()
                .ease('cubic')
            .duration(1000)
                .attr('transform', 'translate(' + xOff + ', ' + yOff + ')')
                .style('fill', '#fff');
    }

    function flyIn(d){
        d3.select(this)
            .transition()
            .delay(1000)
            .duration(500)
                .attr('transform', function(d){
                    return 'translate(' + (-d.xTrans + d.xOffset) + ', ' + (-d.yTrans + d.yOffset) + ')';
                })
            .attr('xTrans', 0)
            .attr('yTrans', 0)
            .style('fill', '#f0ff00');
    }


    function initAllBuildings(arr){
        var left = 0;

        for (building of arr){
            var gridData = initSingleBuilding(building.height, building.width);

            var row = grid.append('svg')
                        .classed('building', true)
                        .attr('height', building.height)
                        .attr('width', building.width)
                        .attr('x', left)
                        .attr('y', canvasHeight - gridData.length * (width + off))
                    .selectAll('.row')
                    .data(gridData)
                    .enter().append('g')
                        .attr('class', 'row');
                        

            var col = row.selectAll('rect')
                    .data(function(d) {return d;})
                    .enter().append('rect')
                        .attr('id', function(d, i) {return 'rect' + i;})
                        .attr('x', function(d) {return d.x;})
                        .attr('y', function(d) {return d.y;})
                        .attr('width', function(d) {return d.width + off;})
                        .attr('height', function(d) {return d.height + off;})
                        .attr('transform', function(d) {return 'translate(' + d.xOffset + ', ' + d.yOffset + ')';}) 
                        .style('fill', '#000')
                        .on('mouseover', flyOut)
                        .on('mouseout', flyIn);

            left += gridData[0].length * (width + off) + 5;
        }
    }

    function exit(){
        d3.selectAll('rect').each(flyOut);
    }

    function enter(){
        d3.selectAll('rect').each(flyIn);
    }

    var grid = canvas
        .append('svg')
        .attr('width', canvasWidth)
        .attr('height', canvasHeight)
        .classed('canvas', true);

    initAllBuildings([
            {
                'height' : 300,
                'width' : 100
            },
            {
                'height' : 500,
                'width' : 50
            },
            {
                'height' : 440,
                'width' : 140
            },
            {
                'height' : 600,
                'width' : 120
            },
            {
                'height' : 350,
                'width' : 90
            },
            {
                'height' : 200,
                'width' : 60
            }
        ]);

    d3.select('body').on('click', exit);
    
</script>
</body>
</html>